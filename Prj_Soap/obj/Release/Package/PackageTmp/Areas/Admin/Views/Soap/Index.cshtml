

@{
    ViewBag.Title = "公告管理";
}
<section class="content-header">
    <h1>
        <b>公告管理</b>
    </h1>
 
</section>

<section class="content">
    <div class="row">
        <div class="col-md-3">
            @Html.Partial("_UploadSoap")
        </div>
        <div class="col-md-9">
            @Html.Partial("_SoapList")
        </div>
    </div>
    
    @*<div class="row">
        <div class="col-md-12">
          
        </div>
    </div>*@
</section>

@section scripts
{
    <script>
        $(document).ready(function () {
            $("#image-file").change(function () {
                var _file = this.files;

                if (_file && _file[0]) {
                    ReadImage(_file[0]);
                }
            });
            $("#btn-soap-upload").on("click", function () {
                var file = $("#image-file").get(0).files;
                var data = new FormData();
                data.append("ImageFile", file[0]);
                data.append("ItemName", $("#txt-soap-name").val());
                data.append("ItemContent", $("#txt-soap-content").val());
                data.append("Price", $("#txt-soap-price").val());
                data.append("IsInStock", $("#chk-soap-instock").is(":checked"))
                $.ajax({
                    type: "POST",
                    url: '/Soap/SoapUpload',
                    contentType: false,
                    processData: false,
                    data: data,
                    success: function (result) {
                        alert("上傳成功");
                        $("#uploaded-soap-img").append("");
                        ClearPreview();
                        ClearText();
                        GetItemList(1);
                    }
                });
            });
           
            GetItemList(1);
            
        });

        var ReadImage = function(file) {
            var reader = new FileReader();
            var image = new Image();

            reader.readAsDataURL(file);
            reader.onload = function(file2) {

                image.src = file2.target.result;
                image.onload = function() {

                    var height = this.height;
                    var width = this.width;
                    var type = file.type;
                    var size = ~~(file.size / 1024) + "KB";

                    $("#targetImg").attr("src", file2.target.result);
                    $("#image-description").text("圖片大小: " + size + ", " + height + "x" + width + ", " + type + "");
                    $("#imgPreview").show();
                }
            }
        }

        var ClearPreview = function() {
            $("#image-file").val("");
            $("#image-description").text("");
            $("#imgPreview").hide();
        }

        function ClearText() {
            $("#txt-soap-content").val("");
            $("#txt-soap-name").val("");
            $("#txt-soap-price").val("");
        }


        function UploadSoap() {
            var file = $("#image-file").get(0).files;
        }

        function GetItemList(page) {
            $.ajax(
                {
                    method: "GET",
                    data: {
                        page: page
                    },
                    url: "/Soap/GetSoapList"
                }
            )
                .done(function (data) {                   
                    $('#tb-soaplist').html('');
                    $.each(data.Soaps, function (index, data) {
                        $('#tb-soaplist').append("<tr> \
                            <td style= 'width:30%;'> \
                               <div class='crop-soap-img'> <img class='img-responsive thumbnail' src='"
                            + data.ImageUrl + "'/>\
                               </div>\
                            </td>\
                            <td>\
                                <a href='#'>" + data.ItemName + "</a>\
                            </td>\
                            <td>" + data.FormattedDate + "</td>\
                            <td><button class='btn-soap-delete btn btn-xs btn-danger' data-id='"+ data.Id +"'><i style='font-size:22px' class='fa fa-remove'></button></i></td>\
                            </tr>"
                        );
                    });

                    $(".btn-soap-delete").on("click", function () {
                        var soapId = $(this).data('id');
                        DeleteSoap(soapId);
                    });
                    GetPagination(data.Total, page);
                    
                });
        }

        function GetPagination(total, currentPage) {
            var pageNumber = Math.ceil(total / 3);
            var startNum = 1, endNum = pageNumber+1;
            $("#soap-list-pagination").html("");
            if (pageNumber >= 5) {
                startNum = currentPage - 2;
                endNum = currentPage + 2;
            }
            for (var i = startNum; i < endNum; i++) {
                if (i == currentPage) {
                    $("#soap-list-pagination")
                        .append("<li class='active'><a class='soaplistpage' href='#' data-page='" + i + "'>" + i + "</a></li>")
                } else {
                    $("#soap-list-pagination")
                        .append("<li><a class='soaplistpage' href='#' data-page='" + i + "'>" + i + "</a></li>")
                }
                
            }

            $(".soaplistpage").click(function () {
                var pageNum = $(this).data("page");
                GetItemList(pageNum);
            });
        }

        function DeleteSoap(id) {
            $.ajax(
                {
                    method: "POST",
                    data: {
                        id: id
                    },
                    url: "/Soap/DeleteSoap"
                }
            )
                .done(function (data) {
                    alert("刪除成功");
                    GetItemList(1);
                })
                .fail(function () {
                    alert("錯誤! 請稍候再試");
                });
        }
    </script>
}
